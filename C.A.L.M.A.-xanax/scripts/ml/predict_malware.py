import sys
import pickle
import warnings
from pathlib import Path
from dataclasses import dataclass

import numpy as np

warnings.filterwarnings('ignore')

                               
from extract_pe_features import extract_pe_features

       
MODEL_PATH = Path(__file__).parent / "Data/modelo_malware.pkl"
SCALER_PATH = Path(__file__).parent / "Data/scaler_malware.pkl"


@dataclass
class MalwareResult:
    file_path: str
    prediction: int                      
    probability_clean: float
    probability_malware: float
    confidence: float
    risk_score: int                                   
    risk_level: str                                      
    
    def __str__(self):
        emoji = "" if self.prediction == 0 else ""
        label = "LIMPO" if self.prediction == 0 else "MALWARE"
        
        return f"""
╔══════════════════════════════════════════════════════════╗
║                  CLASSIFICAÇÃO DE MALWARE                ║
╠══════════════════════════════════════════════════════════╣
║ {emoji} RESULTADO: {label:<45} ║
╠══════════════════════════════════════════════════════════╣
║ Ficheiro: {self.file_path:<46} ║
║                                                          ║
║ PROBABILIDADES:                                          ║
║   Limpo:   {self.probability_clean:6.2%}                                      ║
║   Malware: {self.probability_malware:6.2%}                                      ║
║                                                          ║
║ RISCO:                                                   ║
║   Score:   {self.risk_score:3}/100                                        ║
║   Nível:   {self.risk_level:<46} ║
║   Confiança: {self.confidence:6.2%}                                    ║
╚══════════════════════════════════════════════════════════╝
"""


def load_model():
    if not MODEL_PATH.exists() or not SCALER_PATH.exists():
        raise FileNotFoundError(
            " Modelo não encontrado!\n"
            "   Execute primeiro: python3 modelo_logistica.py train"
        )
    
    with open(MODEL_PATH, 'rb') as f:
        model = pickle.load(f)
    
    with open(SCALER_PATH, 'rb') as f:
        scaler = pickle.load(f)
    
    return model, scaler


def calculate_risk_level(prob_malware: float) -> str:
                                                        
    if prob_malware < 0.20:
        return "LIMPO"
    elif prob_malware < 0.40:
        return "BAIXO"
    elif prob_malware < 0.65:
        return "MÉDIO"
    elif prob_malware < 0.85:
        return "ALTO"
    else:
        return "CRÍTICO"


def predict(file_path: str) -> MalwareResult:
                        
    model, scaler = load_model()
    
                            
    features = extract_pe_features(file_path)
    
                                                                       
    features_input = features[:53] + features[54:]                      
    
                   
    features_scaled = scaler.transform([features_input])
    
                 
    prediction = model.predict(features_scaled)[0]
    probabilities = model.predict_proba(features_scaled)[0]
    
    prob_clean = probabilities[0]
    prob_malware = probabilities[1]
    confidence = max(probabilities)
    
                                                        
    risk_score = int(prob_malware * 100)
    risk_level = calculate_risk_level(prob_malware)
    
    return MalwareResult(
        file_path=file_path,
        prediction=prediction,
        probability_clean=prob_clean,
        probability_malware=prob_malware,
        confidence=confidence,
        risk_score=risk_score,
        risk_level=risk_level
    )


def main():
    if len(sys.argv) < 2:
        print(__doc__)
        sys.exit(1)
    
    file_path = sys.argv[1]
    verbose = '--verbose' in sys.argv
    score_only = '--score-only' in sys.argv
    
    if not Path(file_path).exists():
        print(f" Ficheiro não encontrado: {file_path}")
        sys.exit(1)
    
    try:
        result = predict(file_path)
        
        if score_only:
                                                 
            print(result.risk_score)
        elif verbose:
                             
            print(result)
            print("\n[DEBUG] Features extraídas:")
            features = extract_pe_features(file_path)
            print(f"  Total: {len(features)}")
            print(f"  e_magic: {features[0]}")
            print(f"  Machine: {features[17]}")
            print(f"  Subsystem: {features[44]}")
            print(f"  SuspiciousImports: {features[54]}")
            print(f"  SuspiciousSections: {features[55]}")
        else:
                           
            emoji = "" if result.prediction == 0 else ""
            label = "LIMPO" if result.prediction == 0 else "MALWARE"
            print(f"\n{emoji} {label}")
            print(f"   Probabilidade Malware: {result.probability_malware:.2%}")
            print(f"   Score de Risco: {result.risk_score}/100")
            print(f"   Nível: {result.risk_level}")
        
    except Exception as e:
        print(f" Erro: {e}")
        if verbose:
            import traceback
            traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()
