#!/bin/bash
# CALMA - Random Email Sender with Malware Bazaar Integration
# This script sends test emails with malware samples for testing purposes

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
CONFIG_FILE="${BASE_DIR}/config/malware_bazar_config.json"

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}ERROR: Configuration file not found!${NC}"
    echo -e "${YELLOW}Run: python setup.py${NC}"
    echo -e "${YELLOW}Or create: config/malware_bazar_config.json${NC}"
    exit 1
fi

# Check for jq
if ! command -v jq &> /dev/null; then
    echo -e "${RED}ERROR: 'jq' not found${NC}"
    echo -e "${YELLOW}Install: sudo apt install jq  # Linux${NC}"
    echo -e "${YELLOW}        brew install jq       # macOS${NC}"
    exit 1
fi

# Load configuration from JSON
echo -e "${CYAN}Loading configuration...${NC}"
ENABLED=$(jq -r '.enabled // false' "$CONFIG_FILE")
EMAIL_USER=$(jq -r '.email_user // ""' "$CONFIG_FILE")
EMAIL_PASS=$(jq -r '.email_pass // ""' "$CONFIG_FILE")
AUTH_KEY=$(jq -r '.malware_bazaar_api_key // ""' "$CONFIG_FILE")
MALWARE_BAZAAR_API=$(jq -r '.malware_bazaar_api_url // "https://mb-api.abuse.ch/api/v1/"' "$CONFIG_FILE")
MAX_FILE_SIZE=$(jq -r '.max_file_size // 26214400' "$CONFIG_FILE")
NUM_EMAILS=$(jq -r '.num_emails // 10' "$CONFIG_FILE")
INFECTED_PERCENTAGE=$(jq -r '.infected_percentage // 60' "$CONFIG_FILE")

# Check if enabled
if [ "$ENABLED" != "true" ]; then
    echo -e "${YELLOW}Malware Bazar sender is disabled in config${NC}"
    echo -e "${YELLOW}Set 'enabled': true in $CONFIG_FILE to activate${NC}"
    exit 0
fi

# Validate configuration
if [ -z "$EMAIL_USER" ] || [ "$EMAIL_USER" = "your_test_email@gmail.com" ]; then
    echo -e "${RED}ERROR: Email not configured!${NC}"
    echo -e "${YELLOW}Run: python setup.py${NC}"
    exit 1
fi

if [ -z "$EMAIL_PASS" ] || [ "$EMAIL_PASS" = "your_app_password_16_chars" ]; then
    echo -e "${RED}ERROR: Email password not configured!${NC}"
    echo -e "${YELLOW}Run: python setup.py${NC}"
    exit 1
fi

if [ -z "$AUTH_KEY" ] || [ "$AUTH_KEY" = "your_malware_bazaar_api_key" ]; then
    echo -e "${YELLOW}WARNING: Malware Bazaar API key not configured${NC}"
    echo -e "${YELLOW}Will send clean emails only${NC}"
    AUTH_KEY=""
fi

SAMPLES_DIR="${BASE_DIR}/malware_samples"
UNZIPPED_DIR="${BASE_DIR}/unzipped_samples"
CLEAN_DIR="${BASE_DIR}/clean_attachments"

echo -e "${CYAN}Starting malware bazaar script...${NC}"
echo -e "${GREEN}Config loaded successfully${NC}"

# Detect Python command
if command -v py &> /dev/null; then
    PYTHON_CMD="py"
elif command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
else
    echo -e "${RED}ERROR: Python not found. Please install Python first.${NC}"
    exit 1
fi

echo -e "${GREEN}Using Python command: $PYTHON_CMD${NC}"

echo -e "${BLUE}Preparing directories...${NC}"
mkdir -p "$SAMPLES_DIR"
mkdir -p "$UNZIPPED_DIR"
mkdir -p "$CLEAN_DIR"
echo -e "${GREEN}Directories created: malware_samples, unzipped_samples, clean_attachments${NC}"

create_clean_files() {
    if [ -f "$CLEAN_DIR/invoice_2024.pdf" ]; then
        echo -e "${YELLOW}Clean files already exist, skipping creation...${NC}"
        return
    fi
    
    echo -e "${BLUE}Creating clean attachment files...${NC}"
    
    echo "%PDF-1.4
1 0 obj<</Type/Catalog/Pages 2 0 R>>endobj
2 0 obj<</Type/Pages/Count 1/Kids[3 0 R]>>endobj
3 0 obj<</Type/Page/MediaBox[0 0 612 792]/Parent 2 0 R/Resources<<>>>>endobj
xref
0 4
0000000000 65535 f
0000000009 00000 n
0000000058 00000 n
0000000115 00000 n
trailer<</Size 4/Root 1 0 R>>
startxref
196
%%EOF" > "$CLEAN_DIR/invoice_2024.pdf"
    
    echo "%PDF-1.4
1 0 obj<</Type/Catalog/Pages 2 0 R>>endobj
2 0 obj<</Type/Pages/Count 1/Kids[3 0 R]>>endobj
3 0 obj<</Type/Page/MediaBox[0 0 612 792]/Parent 2 0 R/Resources<<>>>>endobj
xref
0 4
trailer<</Size 4/Root 1 0 R>>
startxref
196
%%EOF" > "$CLEAN_DIR/report_Q1.pdf"
    
    echo "%PDF-1.4
Simple PDF Document" > "$CLEAN_DIR/meeting_notes.pdf"
    
    echo "Project Status Update

All tasks completed on schedule.
Next milestone: February 15, 2024.

Team: Engineering
Status: On Track" > "$CLEAN_DIR/project_status.txt"
    
    echo "Meeting Minutes - January 2024

Attendees: Team A, Team B
Topics Discussed:
- Budget allocation
- Timeline review
- Resource planning

Action Items:
- Complete documentation
- Schedule follow-up meeting" > "$CLEAN_DIR/meeting_minutes.txt"
    
    echo "Budget Report Q4 2023

Total Expenses: \$450,000
Total Revenue: \$620,000
Net Profit: \$170,000

Department Breakdown:
- IT: \$120,000
- Marketing: \$85,000
- Operations: \$245,000" > "$CLEAN_DIR/budget_report.txt"
    
    echo -e "${GREEN}✓ Created clean attachment files${NC}"
}

get_malware_samples() {
    if [ -z "$AUTH_KEY" ]; then
        echo -e "${YELLOW}Skipping malware download (no API key)${NC}"
        return 1
    fi
    
    curl -X POST "$MALWARE_BAZAAR_API" \
         -H "Auth-Key: $AUTH_KEY" \
         -d "query=get_recent&selector=time" \
         -s > "$BASE_DIR/recent_samples.json"
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERROR: Failed to connect to API${NC}"
        return 1
    fi
    return 0
}

extract_samples() {
    echo -e "${BLUE}Extracting malware samples...${NC}"
    
    for zipfile in "$SAMPLES_DIR"/*.zip; do
        if [ -f "$zipfile" ]; then
            echo "Extracting: $(basename "$zipfile")"
            extracted=false
            
            if command -v unzip &> /dev/null; then
                unzip -P infected "$zipfile" -d "$UNZIPPED_DIR/" > /dev/null 2>&1
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✓ Extracted with unzip${NC}"
                    extracted=true
                fi
            fi
            
            if [ "$extracted" = false ] && command -v 7z &> /dev/null; then
                7z x -pinfected -y "$zipfile" -o"$UNZIPPED_DIR/" > /dev/null 2>&1
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✓ Extracted with 7z${NC}"
                    extracted=true
                fi
            fi
            
            if [ "$extracted" = false ]; then
                $PYTHON_CMD << EXTRACT_PY
import zipfile
import sys
try:
    with zipfile.ZipFile("$zipfile", 'r') as z:
        z.extractall("$UNZIPPED_DIR", pwd=b'infected')
    print("✓ Extracted with Python")
except:
    sys.exit(1)
EXTRACT_PY
                if [ $? -eq 0 ]; then
                    extracted=true
                fi
            fi
            
            if [ "$extracted" = false ]; then
                echo "Failed to extract, copying ZIP to unzipped folder"
                cp "$zipfile" "$UNZIPPED_DIR/"
            fi
        fi
    done
}

# Create clean files first
create_clean_files

# Try to get malware samples if API key is configured
if get_malware_samples; then
    echo "Getting malware samples from API..."
    $PYTHON_CMD << PYTHON_SCRIPT
import json
import os
import requests
import random
import time

AUTH_KEY = "$AUTH_KEY"

def download_random_sample():
    try:
        with open('$BASE_DIR/recent_samples.json', 'r') as f:
            data = json.load(f)
        
        print(f"API Status: {data.get('query_status')}")
        
        if data.get('query_status') != 'ok':
            print(f"API query failed: {data.get('query_status')}")
            return False
        
        samples = data.get('data', [])
        print(f"Total samples found: {len(samples)}")
        
        if not samples:
            print("No samples in response")
            return False
        
        random.shuffle(samples)
        
        for sample in samples[:15]:
            file_size = sample.get('file_size', 0)
            if file_size <= $MAX_FILE_SIZE and file_size > 0:
                sha256_hash = sample.get('sha256_hash')
                original_filename = sample.get('file_name', 'document.exe')
                
                convincing_names = [
                    'invoice_payment.pdf', 'contract_final.docx', 'report_2024.xlsx',
                    'presentation.pptx', 'document_signed.pdf', 'financial_statement.xlsx',
                    'proposal_updated.docx', 'receipt.pdf', 'bank_statement.pdf',
                    'tax_form.pdf', 'payslip.pdf', 'agreement.docx'
                ]
                
                clean_filename = random.choice(convincing_names)
                
                print(f"Trying: {original_filename}")
                print(f"Size: {file_size} bytes")
                print(f"Hash: {sha256_hash}")
                
                headers = {
                    'Auth-Key': AUTH_KEY,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
                data_post = {
                    'query': 'get_file',
                    'sha256_hash': sha256_hash
                }
                
                print("Sending download request...")
                response = requests.post("$MALWARE_BAZAAR_API", 
                                       data=data_post,
                                       headers=headers,
                                       timeout=60)
                
                print(f"Response status: {response.status_code}")
                
                if response.status_code == 200:
                    if response.content[:2] == b'PK':
                        zip_filename = f"{clean_filename}.zip"
                        with open(f"$SAMPLES_DIR/{zip_filename}", 'wb') as f:
                            f.write(response.content)
                        print(f"✓ Downloaded: {zip_filename} ({len(response.content)} bytes)")
                        return True
                    else:
                        try:
                            error_data = response.json()
                            print(f"API Error: {error_data.get('query_status', 'unknown')}")
                        except:
                            print(f"Unexpected response format")
                        continue
                else:
                    print(f"Failed: {response.status_code}")
                    continue
        
        print("No valid samples could be downloaded")
        return False
        
    except json.JSONDecodeError as e:
        print(f"JSON Error: {e}")
        return False
    except requests.exceptions.Timeout:
        print("Request timeout")
        return False
    except requests.exceptions.RequestException as e:
        print(f"Request Error: {e}")
        return False
    except Exception as e:
        print(f"Error downloading sample: {e}")
        return False

result = download_random_sample()
if result:
    print("Malware download successful!")
else:
    print("No malware downloaded - will send clean emails only")
PYTHON_SCRIPT

    extract_samples
fi

# Create subject/body files if they don't exist
cd "$BASE_DIR"

if [ ! -f "infectedSubjects.txt" ]; then
    echo "Creating infectedSubjects.txt..."
    cat > infectedSubjects.txt << 'EOF'
URGENTE: Fatura em atraso - Ação imediata necessária
Documento confidencial anexado para revisão
Proposta comercial aprovada - Contrato em anexo
Atualização de segurança crítica - Instale agora
Your PayPal payment has been processed
Amazon order confirmation - Action required
Microsoft security alert - Verify account
Bank statement ready for download
Invoice overdue - Payment required immediately
Account suspended - Verification needed
Password reset confirmation - Secure access
EOF
fi

if [ ! -f "infectedBody.txt" ]; then
    echo "Creating infectedBody.txt..."
    cat > infectedBody.txt << 'EOF'
Segue em anexo o documento solicitado. Por favor, verifique e confirme o recebimento.
Este arquivo contém informações importantes para a análise do projeto. Abra com cuidado.
Your payment has been successfully processed. Please find the receipt attached.
We need to verify your account activity. Click the attachment for more details.
Payment for invoice is now overdue. Immediate action required. See attachment.
Your account has been temporarily suspended. Verify your identity using the attached form.
Your password has been successfully reset. Confirm the changes by opening the attached file.
EOF
fi

if [ ! -f "cleanSubject.txt" ]; then
    echo "Creating cleanSubject.txt..."
    cat > cleanSubject.txt << 'EOF'
Weekly Team Newsletter
Project Status Report - All Good
Meeting Minutes - Last Thursday
Training Materials Available
Company Policy Update
Budget Approval Confirmed
Team Building Event
Monthly Team Update
EOF
fi

if [ ! -f "cleanBody.txt" ]; then
    echo "Creating cleanBody.txt..."
    cat > cleanBody.txt << 'EOF'
Hope this email finds you well. Just wanted to share some positive updates from our team.
Regular weekly newsletter with company updates and announcements. No action required.
Meeting went smoothly yesterday. All objectives were met and next steps are clear.
Training materials are now available on the company portal. Feel free to access anytime.
Budget has been approved for next quarter. Exciting projects ahead.
Team building event was a great success. Thank you all for participating.
Monthly team update with positive results across all departments. Keep up the excellent work.
EOF
fi

echo -e "${CYAN}Sending emails...${NC}"

$PYTHON_CMD << EMAIL_SCRIPT
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders
import os
import random
import time

def get_corresponding_line(subject_file, body_file):
    try:
        with open(subject_file, 'r', encoding='utf-8') as f:
            subjects = f.readlines()
        with open(body_file, 'r', encoding='utf-8') as f:
            bodies = f.readlines()
        
        if subjects and bodies:
            index = random.randint(0, min(len(subjects), len(bodies)) - 1)
            return subjects[index].strip(), bodies[index].strip()
        else:
            return "Default Subject", "Default Body"
    except:
        return "Default Subject", "Default Body"

def send_email():
    print("Starting email sending process...")
    try:
        server = smtplib.SMTP("smtp.gmail.com", 587, timeout=10)
        server.starttls()
        server.login("$EMAIL_USER", "$EMAIL_PASS")
        print("SMTP connection successful")
    except Exception as e:
        print(f"SMTP Error: {e}")
        return
    
    malware_files = []
    for d in ["$SAMPLES_DIR", "$UNZIPPED_DIR"]:
        if os.path.exists(d):
            for f in os.listdir(d):
                path = os.path.join(d, f)
                if os.path.isfile(path) and os.path.getsize(path) <= $MAX_FILE_SIZE:
                    malware_files.append(path)
    
    clean_files = []
    if os.path.exists("$CLEAN_DIR"):
        for f in os.listdir("$CLEAN_DIR"):
            path = os.path.join("$CLEAN_DIR", f)
            if os.path.isfile(path):
                clean_files.append(path)
    
    print(f"Found {len(malware_files)} malware files")
    print(f"Found {len(clean_files)} clean files")
    
    num_emails = $NUM_EMAILS
    infected_percentage = $INFECTED_PERCENTAGE
    print(f"Sending {num_emails} emails with {infected_percentage}% infected")
    
    for i in range(num_emails):
        should_be_infected = random.randint(1, 100) <= infected_percentage
        is_infected = should_be_infected and len(malware_files) > 0
        
        if is_infected:
            subject, body = get_corresponding_line("infectedSubjects.txt", "infectedBody.txt")
            attachment_path = random.choice(malware_files)
            
            msg = MIMEMultipart()
            msg['From'] = "$EMAIL_USER"
            msg['To'] = "$EMAIL_USER"
            msg['Subject'] = subject
            msg.attach(MIMEText(body, 'plain'))
            
            filename = os.path.basename(attachment_path)
            with open(attachment_path, 'rb') as f:
                part = MIMEBase('application', 'octet-stream')
                part.set_payload(f.read())
                encoders.encode_base64(part)
                part.add_header('Content-Disposition', f'attachment; filename="{filename}"')
                msg.attach(part)
            
            print(f"[INFECTED] Email {i+1}: {subject[:50]}...")
        else:
            subject, body = get_corresponding_line("cleanSubject.txt", "cleanBody.txt")
            
            msg = MIMEMultipart()
            msg['From'] = "$EMAIL_USER"
            msg['To'] = "$EMAIL_USER"
            msg['Subject'] = subject
            msg.attach(MIMEText(body, 'plain'))
            
            # 50% of clean emails have attachment
            if clean_files and random.randint(1, 100) <= 50:
                attachment_path = random.choice(clean_files)
                filename = os.path.basename(attachment_path)
                with open(attachment_path, 'rb') as f:
                    part = MIMEBase('application', 'octet-stream')
                    part.set_payload(f.read())
                    encoders.encode_base64(part)
                    part.add_header('Content-Disposition', f'attachment; filename="{filename}"')
                    msg.attach(part)
                print(f"[CLEAN+ATT] Email {i+1}: {subject[:50]}...")
            else:
                print(f"[CLEAN] Email {i+1}: {subject[:50]}...")
        
        try:
            server.send_message(msg)
            print(f"  ✓ Sent successfully")
        except Exception as e:
            error_str = str(e)
            if "552" in error_str or "blocked" in error_str.lower():
                print(f"  ! Likely sent (Google flagged as malware)")
            elif "connect" in error_str.lower() or "closed" in error_str.lower() or "timeout" in error_str.lower():
                print(f"  ! Connection lost, reconnecting...")
                try:
                    server = smtplib.SMTP("smtp.gmail.com", 587, timeout=10)
                    server.starttls()
                    server.login("$EMAIL_USER", "$EMAIL_PASS")
                    server.send_message(msg)
                    print(f"  ✓ Reconnected and sent")
                except Exception as retry_error:
                    print(f"  ✗ Failed: {retry_error}")
            else:
                print(f"  ✗ Error: {e}")
        
        if i < num_emails - 1:
            time.sleep(2)
    
    try:
        server.quit()
        print("\\nEmail sending completed!")
    except:
        pass

send_email()
EMAIL_SCRIPT

# Cleanup
rm -f "$BASE_DIR/recent_samples.json"

echo -e "${YELLOW}Cleaning up infected files...${NC}"
rm -rf "$SAMPLES_DIR"
rm -rf "$UNZIPPED_DIR"
echo -e "${GREEN}✓ Infected files deleted${NC}"

echo -e "${GREEN}Done.${NC}"
